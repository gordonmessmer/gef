name: Tests

env:
  GEF_CI_NB_CPU: 1

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        os: [ubuntu-24.04, ubuntu-22.04, fedora-42, fedora-43, fedora-rawhide]
        include:
          - os: ubuntu-24.04
            base_image: ubuntu:24.04
          - os: ubuntu-22.04
            base_image: ubuntu:22.04
          - os: fedora-42
            base_image: fedora:42
          - os: fedora-43
            base_image: fedora:43
          - os: fedora-rawhide
            base_image: fedora:rawhide

    name: "Run Unit tests on ${{ matrix.os }} (${{ matrix.arch }})"
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM ${{ matrix.base_image }}

        # Install dependencies for Ubuntu-based images
        RUN if [ -f /etc/debian_version ]; then \
          export DEBIAN_FRONTEND=noninteractive NEEDRESTART_MODE=n && \
          apt-get update && \
          apt-get install -y gdb-multiarch python3-dev python3-pip python3-wheel python3-setuptools \
            git cmake gcc g++ pkg-config libglib2.0-dev gdbserver qemu-user file; \
        fi

        # Install python3-full for Ubuntu 24.04
        RUN if grep -q "24.04" /etc/os-release 2>/dev/null; then \
          apt-get install -y python3-full; \
        fi

        # Install dependencies for Fedora-based images
        RUN if [ -f /etc/fedora-release ]; then \
          dnf install -y gdb gdb-gdbserver python3-devel python3-pip python3-wheel python3-setuptools python3-rpm \
            git cmake gcc gcc-c++ pkg-config glib2-devel qemu-user qemu-user-static file procps-ng && \
          dnf --enablerepo='*debug*' install -y glibc-debuginfo && \
          dnf clean all; \
        fi

        # Copy only requirements.txt for caching
        COPY tests/requirements.txt /tmp/requirements.txt

        # Install Python requirements
        RUN PY_VER=$(gdb -q -nx -ex "pi print('.'.join(map(str, sys.version_info[:2])))" -ex quit 2>/dev/null || echo "3") && \
          if grep -q "24.04" /etc/os-release 2>/dev/null; then \
            python${PY_VER} -m pip install --break-system-packages --upgrade -r /tmp/requirements.txt; \
          else \
            python${PY_VER} -m pip install --upgrade -r /tmp/requirements.txt; \
          fi

        RUN git config --global --add safe.directory /gef

        WORKDIR /gef

        EOF

    - name: Build container image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        load: true
        tags: gef-test:${{ matrix.os }}-${{ matrix.arch }}
        cache-from: type=gha,scope=${{ matrix.os }}-${{ matrix.arch }}
        cache-to: type=gha,mode=max,scope=${{ matrix.os }}-${{ matrix.arch }}

    - name: Run tests in container
      run: |
        docker run --privileged --rm -v "$PWD:/gef" gef-test:${{ matrix.os }}-${{ matrix.arch }} bash -c '
          PY_VER=$(gdb -q -nx -ex "pi print('\''.'\''.join(map(str, sys.version_info[:2])))" -ex quit 2>/dev/null || echo "3")
          GEF_CI_NB_CPU=$(grep -c ^processor /proc/cpuinfo)

          # Setup GEF
          echo "source /gef/gef.py" > /root/.gdbinit

          # Verify GEF setup
          gdb -q -ex "gef missing" -ex "gef help" -ex "gef config" -ex start -ex continue -ex quit /bin/pwd

          # Build test binaries
          make -C tests/binaries -j ${GEF_CI_NB_CPU}

          # Run pytest
          python${PY_VER} -m pytest --forked -n ${GEF_CI_NB_CPU} -v -m "not benchmark" tests/
        '
